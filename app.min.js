const MESSAGES={ERROR:{SELECT_GAME:"กรุณาเลือกม็อด",DOWNLOAD_FAILED:"ดาวน์โหลดไม่สำเร็จ",INSTALL_FAILED:"เกิดข้อผิดพลาดในการติดตั้งม็อด",LOAD_FAILED:"เกิดข้อผิดพลาดในการโหลดม็อด",MOD_NOT_FOUND:"ไม่พบข้อมูลสำหรับเกมที่เลือก",SELECT_FOLDER:"กรุณาเลือกโฟลเดอร์",UPDATE_MOD:"พบเวอร์ชันใหม่ของม็อด! ต้องการอัปเดตหรือไม่?"},STATUS:{DOWNLOADING_INSTALLING:"กำลังดาวน์โหลดและติดตั้งม็อด...",INSTALL_SUCCESS:"ติดตั้งม็อดสำเร็จ"}},statusMessages=new Map([["notAvailable","ไม่พร้อมใช้งาน"],["updating","🔄 กำลังอัปเดต"],["inTranslation","✨ กำลังแปล"],["underReview","กำลังตรวจสอบ"]]);let isInstalling=!1,modList={},selectedGameId=null;function renderProgressMessage(e){document.getElementById("progress-message").textContent=e}function isGameSelected(){return!!selectedGameId||(renderProgressMessage(MESSAGES.ERROR.SELECT_GAME),!1)}async function loadModList(){try{const e=await fetch("modlist.json");if(!e.ok)throw new Error("Network response was not ok");modList=await e.json(),renderTranslators(modList.translators)}catch(e){renderProgressMessage(MESSAGES.ERROR.LOAD_FAILED),console.error(e)}}function renderTranslators(e){const t=document.getElementById("translator-select-container");t.innerHTML="",Object.keys(e).forEach((s=>{const n=e[s];renderMods(t,n.mods),t.appendChild(document.createElement("br"))}))}function renderMods(e,t){const s=document.createElement("div");s.classList.add("translator-mods"),e.appendChild(s),t.forEach((e=>{const t=document.createElement("div");t.classList.add("game-card"),t.dataset.game=e.id;const n=document.createElement("input");n.type="radio",n.name="game",n.value=e.id,n.style.display="none";const a=document.createElement("img");if(a.src=e.image,a.alt=e.name,a.loading="lazy",statusMessages.has(e.status)){const s=document.createElement("div");s.classList.add("status-message"),s.textContent=statusMessages.get(e.status),t.appendChild(s)}t.appendChild(n),t.appendChild(a),s.appendChild(t),t.addEventListener("click",(()=>handleModSelection(t,e)))}))}function handleModSelection(e,t){const s=document.getElementById("install-mod-btn");statusMessages.has(t.status)?(s.disabled=!0,s.title="ม็อดนี้ไม่สามารถติดตั้งได้"):(s.disabled=!1,s.title="คลิกเพื่อติดตั้งม็อด"),resetSelection(),e.classList.add("selected"),e.querySelector("input").checked=!0,selectedGameId=t.id,s.textContent=t.manual_url?"ดาวน์โหลดม็อด":"ติดตั้งม็อด",renderProgressMessage(`ม็อดภาษาไทยเกม: ${t.name}`);const n=t.platform&&Array.isArray(t.platform)?t.platform.join(", "):"ไม่ทราบข้อมูล";let a=e.querySelector(".platform-label");a||(a=document.createElement("div"),a.classList.add("platform-label"),e.appendChild(a)),a.textContent=`${n}`}function resetSelection(){document.querySelectorAll(".game-card").forEach((e=>{e.classList.remove("selected"),e.querySelector("input").checked=!1}))}async function installMod(){if(isInstalling||!isGameSelected())return;const e=getSelectedMod();if(e)if(e.manual_url)window.open(e.manual_url,"_self");else try{const t=await window.showDirectoryPicker();if(!validateInstallation(t))return;isInstalling=!0,await downloadAndInstallMod(e,t),renderProgressMessage(MESSAGES.STATUS.INSTALL_SUCCESS)}catch(e){renderProgressMessage(MESSAGES.ERROR.INSTALL_FAILED),console.error(e)}finally{isInstalling=!1}else renderProgressMessage(MESSAGES.ERROR.MOD_NOT_FOUND)}function validateInstallation(e){return selectedGameId?!!e||(renderProgressMessage(MESSAGES.ERROR.SELECT_FOLDER),!1):(renderProgressMessage(MESSAGES.ERROR.SELECT_GAME),!1)}async function downloadAndInstallMod(e,t){try{renderProgressMessage(MESSAGES.STATUS.DOWNLOADING_INSTALLING);const s=await fetch(e.url);if(!s.ok)throw new Error(MESSAGES.ERROR.DOWNLOAD_FAILED);const n=s.headers.get("Content-Length");if(!n)throw new Error("ไม่สามารถตรวจสอบขนาดไฟล์ได้");const a=parseInt(n,10);let r=0;const o=e=>{if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,t)).toFixed(2)} ${["Bytes","KB","MB","GB","TB"][t]}`},l=s.body.getReader(),d=[];for(;;){const{done:e,value:t}=await l.read();if(e)break;d.push(t),r+=t.length;const s=Math.round(r/a*100);renderProgressMessage(`ดาวน์โหลดแล้ว ${o(r)} / ${o(a)} (${s}%)`)}renderProgressMessage("กำลังติดตั้งม็อด...");const i=new Blob(d),c=await JSZip.loadAsync(i);await extractZipToDirectory(c,t)}catch(e){throw e}}async function extractZipToDirectory(e,t){const s=Object.entries(e.files),n=s.length;let a=0;const r=s.map((async([e,s])=>{const r=e.split("/");let o=t;for(let e=0;e<r.length-1;e++){const t=r[e];o=await o.getDirectoryHandle(t,{create:!0})}if(!s.dir){const e=r[r.length-1],t=await s.async("blob"),n=await o.getFileHandle(e,{create:!0}),a=await n.createWritable();await a.write(t),await a.close()}a++,renderProgressMessage(`กำลังติดตั้งม็อด... (${Math.round(a/n*100)}%)`)}));await Promise.all(r)}function getSelectedMod(){for(let e in modList.translators)for(let t of modList.translators[e].mods)if(t.id===selectedGameId)return t;return null}loadModList(),document.getElementById("install-mod-btn").addEventListener("click",installMod);